<!-- Composant commun de profil - Formulaires de modification -->

<!-- Section Profil -->
<div class="profile-section">
    <div class="section-header">
        <h2>Informations personnelles</h2>
        <button class="edit-btn" onclick="toggleEdit('profile')">Modifier</button>
    </div>
    
    <form id="profile-form" class="profile-form" onsubmit="updateProfile(event)">
        <div class="form-row">
            <div class="form-group">
                <label for="first_name">Prénom</label>
                <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" disabled>
            </div>
            <div class="form-group">
                <label for="last_name">Nom</label>
                <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" disabled>
            </div>
        </div>
        
        {% if user_type == 'customer' %}
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="mail" value="{{ user.customer_mail }}" disabled>
            </div>
            <div class="form-group">
                <label for="phone">Téléphone</label>
                <input type="tel" id="phone" name="phone" value="{{ user.customer_phone }}" disabled>
            </div>
        </div>
        {% else %}
        <div class="form-group">
            <label for="phone">Téléphone</label>
            <input type="tel" id="phone" name="phone" value="{{ user.driver_phone }}" disabled>
        </div>
        {% endif %}
        
        <div class="form-actions" style="display: none;">
            <button type="button" class="btn-secondary" onclick="cancelEdit('profile')">Annuler</button>
            <button type="submit" class="btn-primary">Enregistrer</button>
        </div>
    </form>
</div>

<!-- Section Adresse (uniquement pour customer) -->
{% if user_type == 'customer'%}
<div class="profile-section">
    <div class="section-header">
        <h2>Adresse de livraison</h2>
        <button class="edit-btn" onclick="toggleEdit('address')">Modifier</button>
    </div>
    
    <form id="address-form" class="profile-form" onsubmit="updateAddress(event)">
        <div class="form-group">
            <label for="address_street">Rue</label>
            <input type="text" id="address_street" name="address_street" value="{{ user.customer_address.address_street }}" disabled>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="address_number">Numéro</label>
                <input type="number" id="address_number" name="address_number" value="{{ user.customer_address.address_number }}" disabled>
            </div>
            <div class="form-group">
                <label for="address_postal_code">Code postal</label>
                <input type="number" id="address_postal_code" name="address_postal_code" value="{{ user.customer_address.address_postal_code }}" disabled>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="address_city">Ville</label>
                <input type="text" id="address_city" name="address_city" value="{{ user.customer_address.address_city }}" disabled>
            </div>
            <div class="form-group">
                <label for="address_country">Pays</label>
                <input type="text" id="address_country" name="address_country" value="{{ user.customer_address.address_country }}" disabled>
            </div>
        </div>
        
        <div class="form-actions" style="display: none;">
            <button type="button" class="btn-secondary" onclick="cancelEdit('address')">Annuler</button>
            <button type="submit" class="btn-primary">Enregistrer</button>
        </div>
    </form>
</div>
{% endif %}

<!-- Section Mot de passe -->
<div class="profile-section">
    <div class="section-header">
        <h2>Mot de passe</h2>
        <button class="edit-btn" onclick="toggleEdit('password')">Modifier</button>
    </div>
    
    <form id="password-form" class="profile-form" onsubmit="updatePassword(event)" style="display: none;">
        <div class="form-group">
            <label for="current_password">Mot de passe actuel</label>
            <input type="password" id="current_password" name="current_password" placeholder="Votre mot de passe actuel" required>
        </div>
        
        <div class="form-group">
            <label for="new_password">Nouveau mot de passe</label>
            <input type="password" id="new_password" name="new_password" placeholder="Minimum 8 caractères" minlength="8" required>
        </div>
        
        <div class="form-group">
            <label for="confirm_password">Confirmer le mot de passe</label>
            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirmez votre nouveau mot de passe" minlength="8" required>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="cancelEdit('password')">Annuler</button>
            <button type="submit" class="btn-primary">Modifier le mot de passe</button>
        </div>
    </form>
    
    <div id="password-placeholder">
        <p style="color: #7f8c8d;">Cliquez sur "Modifier" pour changer votre mot de passe</p>
    </div>
</div>

<script>
    // Variables pour stocker les valeurs originales
    let originalProfileData = {};
    let originalAddressData = {};

    // Toggle edit mode pour chaque section
    function toggleEdit(section) {
        if (section === 'profile') {
            const form = document.getElementById('profile-form');
            const inputs = form.querySelectorAll('input');
            const actions = form.querySelector('.form-actions');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            // Sauvegarder les valeurs originales
            originalProfileData = {};
            inputs.forEach(input => {
                input.disabled = false;
                originalProfileData[input.name] = input.value;
            });
            
            actions.style.display = 'flex';
            editBtn.style.display = 'none';
            
        } else if (section === 'address') {
            const form = document.getElementById('address-form');
            const inputs = form.querySelectorAll('input');
            const actions = form.querySelector('.form-actions');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            // Sauvegarder les valeurs originales
            originalAddressData = {};
            inputs.forEach(input => {
                input.disabled = false;
                originalAddressData[input.name] = input.value;
            });
            
            actions.style.display = 'flex';
            editBtn.style.display = 'none';
            
        } else if (section === 'password') {
            const form = document.getElementById('password-form');
            const placeholder = document.getElementById('password-placeholder');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            form.style.display = 'block';
            placeholder.style.display = 'none';
            editBtn.style.display = 'none';
        }
    }

    // Annuler les modifications
    function cancelEdit(section) {
        if (section === 'profile') {
            const form = document.getElementById('profile-form');
            const inputs = form.querySelectorAll('input');
            const actions = form.querySelector('.form-actions');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            // Restaurer les valeurs originales
            inputs.forEach(input => {
                input.disabled = true;
                input.value = originalProfileData[input.name] || '';
            });
            
            actions.style.display = 'none';
            editBtn.style.display = 'block';
            
        } else if (section === 'address') {
            const form = document.getElementById('address-form');
            const inputs = form.querySelectorAll('input');
            const actions = form.querySelector('.form-actions');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            // Restaurer les valeurs originales
            inputs.forEach(input => {
                input.disabled = true;
                input.value = originalAddressData[input.name] || '';
            });
            
            actions.style.display = 'none';
            editBtn.style.display = 'block';
            
        } else if (section === 'password') {
            const form = document.getElementById('password-form');
            const placeholder = document.getElementById('password-placeholder');
            const editBtn = form.previousElementSibling.querySelector('.edit-btn');
            
            form.reset();
            form.style.display = 'none';
            placeholder.style.display = 'block';
            editBtn.style.display = 'block';
        }
    }

    // Mettre à jour le profil
    async function updateProfile(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = {};
        
        // Construire l'objet avec les bons noms de paramètres
        const userType = '{{ user_type }}';
        if (userType === 'customer') {
            data.customer_first_name = formData.get('first_name');
            data.customer_last_name = formData.get('last_name');
            data.customer_mail = formData.get('mail');
            data.customer_phone = formData.get('phone');
        } else {
            data.driver_first_name = formData.get('first_name');
            data.driver_last_name = formData.get('last_name');
            data.driver_phone = formData.get('phone');
        }
        
        try {
            const endpoint = userType === 'customer' ? '/customer/me' : '/drivers/me';
            const response = await fetch(endpoint, {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Profil mis à jour avec succès !');
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Erreur: ' + (error.detail || 'Impossible de mettre à jour le profil'));
            }
        } catch (error) {
            alert('Erreur: ' + error.message);
        }
    }

    // Mettre à jour l'adresse
    async function updateAddress(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = {
            address_street: formData.get('address_street'),
            address_number: parseInt(formData.get('address_number')),
            address_postal_code: parseInt(formData.get('address_postal_code')),
            address_city: formData.get('address_city'),
            address_country: formData.get('address_country')
        };
        
        try {
            const response = await fetch('/customer/address', {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Adresse mise à jour avec succès !');
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Erreur: ' + (error.detail || 'Impossible de mettre à jour l\'adresse'));
            }
        } catch (error) {
            alert('Erreur: ' + error.message);
        }
    }

    // Mettre à jour le mot de passe
    async function updatePassword(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = {
            current_password: formData.get('current_password'),
            new_password: formData.get('new_password'),
            confirm_password: formData.get('confirm_password')
        };
        
        if (data.new_password !== data.confirm_password) {
            alert('Les mots de passe ne correspondent pas !');
            return;
        }
        
        try {
            const response = await fetch('/customer/me/password', {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Mot de passe modifié avec succès !');
                cancelEdit('password');
            } else {
                const error = await response.json();
                alert('Erreur: ' + (error.detail || 'Impossible de modifier le mot de passe'));
            }
        } catch (error) {
            alert('Erreur: ' + error.message);
        }
    }
</script>